#!/usr/bin/env bash

h=/home/aghost-7

create-container() {
	docker run -ti \
		--privileged \
		--rm --name $name \
		--detach-keys 'ctrl-q,ctrl-q' \
		-u `id -u $USER` \
		-v `readlink -f /var/run/docker.sock`:/var/run/docker.sock \
		-v $HOME/workspaces:$h/workspaces \
		-v /etc/localtime:/etc/localtime:ro \
		-v $HOME/.gitconfig:$h/.gitconfig \
		-v $HOME/.ssh/:$h/.ssh \
		-e DISPLAY=$DISPLAY \
		-v /tmp/.X11-unix:/tmp/.X11-unix:ro \
		--net=dev \
		aghost7/$1:$2 \
		tmux new
}

run-dev() {
	name=$1
	tag=$2
	xhost +si:localuser:$USER > /dev/null
	if [ ! -f ~/.gitconfig ]; then
		touch ~/.gitconfig
	fi
	if [ "$(docker network ls | awk '$2 == "dev" { print $1; }')" == "" ]; then
		docker network create dev
	fi
	create-container "$@"
}

run-db() {
	if [ "$(docker ps | awk "\$2 ~ /$1/ { print \$1 }")" == "" ]; then
		docker run --net=dev --rm --name "$1" "aghost7/$1:$2"
		exit 0
	fi
	docker exec -ti "$1" bash
}

case "$1" in
	py)
		run-dev py-dev 2.7
		;;
	rust)
		run-dev rust-dev stable
		;;
	node)
		run-dev nodejs-dev boron
		;;
	scala)
		run-dev scala-dev latest
		;;
	go)
		run-dev go-dev 1.6
		;;
	cljs)
		run-dev cljs-dev latest
		;;
	pg)
		run-db pg-dev 9.3
		;;
	my)
		run-db my-dev 5.6
		;;
	*)
		echo Bad argument \"$1\"
		exit 1
		;;
esac
